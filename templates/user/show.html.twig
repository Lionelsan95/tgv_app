{% extends 'base.html.twig' %}

{% block title %}User{% endblock %}

{% block body %}

    <div class="row">
        <div class="col-xs-12 col-xl-8 offset-xl-1 w-100 sup-frame p-5">
            <div class="d-flex justify-content-between align-items-center mb-5 color-first-color">
                <h1 class="color-third-color"><i class="fas fa-hashtag color-third-color"></i> My account</h1>
                <div class="d-flex">
                    <a href="{{ path('user_edit', {'id':user.id}) }}" class="btn color-first-color d-flex justify-content-between align-items-center">
                        <span class="fa-stack" style="vertical-align: top;">
                          <i class="fas fa-circle fa-stack-2x"></i>
                          <i class="fas fa-plus fa-stack-1x fa-inverse"></i>
                        </span>
                        Update
                    </a>
                    <button id="blockUser" class="btn color-first-color d-flex justify-content-between align-items-center">
                        <span class="fa-stack" style="vertical-align: top;">
                          <i class="fas fa-circle fa-stack-2x"></i>
                          <i class="fas {% if user.enabled %}fa-ban{% else %}fa-unlock{% endif %} fa-stack-1x fa-inverse"></i>
                        </span>
                        <img id="loader" style="display: none" src="{{ asset('images/loader.gif') }}" width="40%"/>
                        {% if user.enabled %} Block {% else %} Activate {% endif %}
                    </button>
                </div>

            </div>

            <div class="inf-frame">
                <div class="container-fluid">
                    <div class="row border-main-grey rounded-1">
                        <div class="col-sm-12">
                            <div class="row">
                                <div class="col-sm-3 d-flex justify-content-center align-items-center">
                                    <i class="fas fa-user color-first-color fa-4x"></i>
                                </div>
                                <div class="col-xs-12 col-sm-9">
                                    <div class="row">
                                        <div class="col-sm-12">
                                            <h2 class="color-third-color">{{ user.firstName ~ ' ' ~ user.lastName }}</h2>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-4">
                                            <p>Email :</p>
                                        </div>
                                        <div class="col-8">
                                            <p class="text-muted">{{ user.email }}</p>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-4">
                                            <p>Balance :</p>
                                        </div>
                                        <div class="col-8">
                                            <p class="text-muted">{{ user.solde }}</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div id="chart_div" style="width: 100%; height: 350px;"></div>
                    </div>
                </div>
            </div>

        </div>
    </div>

{% endblock %}
{% block javascripts %}
    {{ parent() }}
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <script type="text/javascript">
        $(document).ready(function (){
            google.charts.load('current', {'packages':['corechart']});
            google.charts.setOnLoadCallback(drawChart);

            var datum = Array.of(Array.of('Data', 'Balance(GV)'));
            {% for h in user.priceHistories %}
                datum.push(Array.of('{{ h.stringDate }}',parseFloat('{{ h.oldPrice }}')))
            {% endfor %}
                datum.push(Array.of('{{ now }}',parseFloat('{{ user.solde }}')))
            function drawChart() {
                var data = google.visualization.arrayToDataTable(datum);
                var options = {
                    title: 'Balance variation history',
                    hAxis: {title: 'Date',  titleTextStyle: {color: '#333'}},
                    vAxis: {minValue: 0}
                };

                var chart = new google.visualization.AreaChart(document.getElementById('chart_div'));
                chart.draw(data, options);
            }

            $("#blockUser").on('click', function(){
                $("#loader").show();
                $.post(
                    "{{ path('user_block', {'id': user.id}) }}",
                    {
                        _token: "{{ csrf_token('block' ~ user.id) }}",
                    }
                ).done(function(data) {
                    $("#loader").hide();
                    if(data == 1)
                    {
                        alert('Done!');
                    }else{
                        alert('Unable to block the user');
                    }
                }).fail(function(data){
                    alert('error');
                });
            });
        });
    </script>
{% endblock %}
